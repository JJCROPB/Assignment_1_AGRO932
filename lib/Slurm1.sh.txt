#!/bin/bash -l
#SBATCH -D /home/frelslab/juandj/assignment/Assignment_1_AGRO932/
#SBATCH -o /home/frelslab/juandj/assignment/Assignment_1_AGRO932/data/out/sal_out.txt
#SBATCH -e /home/frelslab/juandj/assignment/Assignment_1_AGRO932/data/out/sal_err.txt
#SBATCH -J juan
#SBATCH -t 24:00:00

set -e
set -u

cd data/

wgsim sal.fa -N 5000 -1 100 -2 100 -r 0.01 -e 0 \
-R 0 -X 0 -S 1234567 l1.R1.fq l1.R2.fq

for i in {1..10}
do
   wgsim sal.fa -N 5000 -1 100 -2 100 -r 0.01 -e 0 -R 0 -X 0 l$i.R1.fq l$i.R2.fq
done
# to check how many reads
wc -l l1.R1.fq


# to do the alignment
module load bwa samtools bcftools
# index the reference genome
bwa index sal.fa
# using bwa mem to align the reads to the reference genome 
# => samtools to convert into bam file
bwa mem sal.fa l1.R1.fq l1.R2.fq | samtools view -bSh - > l1.bam

# alignment for 5 individuals
for i in {1..5}; do bwa mem sal.fa l$i.R1.fq l$i.R2.fq | samtools view -bSh - > l$i.bam; done
# sort
for i in *.bam; do samtools sort $i -o sorted_$i; done
# index them
for i in sorted*.bam; do samtools index $i; done

#to calling SNPS

### index the genome assembly
samtools faidx sal.fa

### run 'mpileup' to generate VCF format
samtools mpileup -g -f sal.fa sorted_l1.bam sorted_l2.bam sorted_l3.bam sorted_l4.bam sorted_l5.bam > myraw.bcf
### Call SNP using bcftools `call` function
bcftools call myraw.bcf -cv -Ob -o snps.bcf
### Extract allele frequency at each position
bcftools query -f '%CHROM %POS %AF1\n' snps.bcf > frq.txt
bcftools query -f '%CHROM %POS %REF %ALT [\t%GT]\n' snps.bcf > geno.txt